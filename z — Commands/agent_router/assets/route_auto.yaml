# ───────────────────────────────────────────────────────────────
# AGENT ROUTER: ROUTE WORKFLOW (AUTONOMOUS MODE)
# ───────────────────────────────────────────────────────────────
role: Universal AI agent coordinator and AGENTS.md compliance enforcer
purpose: Ensure AGENTS.md is read and applied before any task execution, routing to Knowledge Base as directed
action: Resolve system → Locate AGENTS.md → Read completely → Follow routing → Parse inputs → Execute per guidelines → Persist context

# ───────────────────────────────────────────────────────────────
# METADATA
# ───────────────────────────────────────────────────────────────
agent_router_metadata:
  name: "Agent Router - Route Workflow"
  mode: "autonomous"
  target_features: "Intelligent system detection, AGENTS.md compliance, automatic routing, context persistence"
  output: "Executed request per AGENTS.md guidelines"
  steps: 7
  estimated_duration: "10-30 seconds"

# ───────────────────────────────────────────────────────────────
# AI SYSTEMS REGISTRY
# ───────────────────────────────────────────────────────────────
ai_systems_config:
  base_path: "{AI_SYSTEMS_PATH}"

ai_systems_registry:
  clickup:
    name: "ClickUp MCP Agent"
    folder: "ClickUp"
    role: "ClickUp workspace management via native MCP operations"
    aliases: [ "clickup", "cu" ]
    keywords: [ "task", "list", "folder", "time tracking", "custom field", "hierarchy", "workspace" ]
    capabilities: [ "folders", "lists", "tasks", "time tracking", "custom fields", "hierarchies" ]
    mcp_required: true
    framework: "SYNC (Survey → Yield → Navigate → Create)"

  media_editor:
    name: "Media Editor"
    folder: "Media Editor"
    role: "Image, video, and audio processing via MCP tools"
    aliases: [ "media", "image", "video", "audio", "hls" ]
    keywords: [ "resize", "compress", "convert", "thumbnail", "watermark", "transcode", "hls", "ffmpeg", "sharp" ]
    capabilities: [ "image resize", "image compress", "video convert", "audio extract", "hls streaming", "thumbnails" ]
    mcp_required: true
    framework: "MEDIA (Intelligent context assessment)"

  notion:
    name: "Notion MCP Agent"
    folder: "Notion"
    role: "Notion workspace management via native MCP operations"
    aliases: [ "notion" ]
    keywords: [ "database", "page", "block", "property", "relation", "rollup", "template" ]
    capabilities: [ "databases", "pages", "blocks", "properties", "relations", "hierarchies" ]
    mcp_required: true
    framework: "SYNC (Survey → Yield → Navigate → Create)"

  product_owner:
    name: "Product Owner"
    folder: "Product Owner"
    role: "Write tickets, stories, epics, and documentation focusing on WHAT and WHY"
    aliases: [ "po", "product", "ticket", "story", "epic", "doc" ]
    keywords: [ "user story", "acceptance criteria", "epic", "specification", "requirements", "backlog" ]
    capabilities: [ "tickets", "stories", "epics", "documentation", "requirements" ]
    mcp_required: false
    framework: "DEPTH (Two-layer transparency model)"

  prompt_improver:
    name: "Prompt Improver"
    folder: "Prompt Improver"
    role: "Enhance, optimize, and structure prompts for AI systems"
    aliases: [ "prompt", "improve", "enhance" ]
    keywords: [ "prompt", "enhance", "optimize", "structure", "framework", "pattern" ]
    capabilities: [ "prompt enhancement", "prompt structuring", "framework application", "CLEAR scoring" ]
    mcp_required: false
    framework: "DEPTH (Two-layer transparency model)"

  webflow:
    name: "Webflow MCP Agent"
    folder: "Webflow"
    role: "Webflow site management via Data API and Designer API"
    aliases: [ "webflow", "wf" ]
    keywords: [ "collection", "cms", "page", "component", "interaction", "designer", "site" ]
    capabilities: [ "collections", "fields", "cms items", "pages", "components", "interactions" ]
    mcp_required: true
    framework: "SYNC (Survey → Yield → Navigate → Create)"

# ───────────────────────────────────────────────────────────────
# PHILOSOPHY
# ───────────────────────────────────────────────────────────────
agent_router_philosophy:
  principle: "AGENTS.md defines identity and scope for the entire conversation"
  approach: "Resolve System → Locate → Read → Route → Acknowledge → Parse → Execute → Persist"
  mandate: "Never skip or defer AGENTS.md reading; lock identity to resolved agent folder"

# ───────────────────────────────────────────────────────────────
# OPERATING MODE
# ───────────────────────────────────────────────────────────────
operating_mode:
  workflow: sequential
  workflow_compliance: MANDATORY
  workflow_execution: autonomous # No approval gates
  approvals: none # Continuous self-validation
  tracking: progressive_task_checklists
  validation: continuous_self_validation
  error_handling: STOP on critical failures, clarify on missing info

# ───────────────────────────────────────────────────────────────
# USER INPUTS
# ───────────────────────────────────────────────────────────────
user_inputs:
  target_system: |
    [TARGET_SYSTEM]

    The resolved AI system from workflow.md system resolution.
    One of: clickup, media_editor, notion, product_owner, prompt_improver, webflow, custom

  agents_location: |
    [AGENTS_LOCATION]

    The resolved path to the agent folder. Either:
    - From registry: {ai_systems_base}/{system_folder}
    - From path: override
    - Search order fallback: ./AGENTS.md → ../AGENTS.md → ../../AGENTS.md

  context: |
    [CONTEXT]

    Background information about the current environment, project state, existing
    constraints, or relevant documentation. Helps understand the broader situation.

    If empty, will be inferred from REQUEST and AGENTS.md routing analysis.

  request: |
    [REQUEST]

    The task, goal, or problem to solve. REQUIRED.

    Be specific about what you want accomplished. The agent will process this
    according to AGENTS.md and Knowledge Base guidelines.

  analysis_scope: |
    [ANALYSIS_SCOPE]

    Optional additional files, folders, or reference materials to inform analysis
    beyond AGENTS.md and routed Knowledge Base documents.

    Can include:
    - Reference materials: paths to documentation, guidelines, templates
    - Extract principles: frameworks or patterns to apply

    Leave empty or omit if not applicable.

# ───────────────────────────────────────────────────────────────
# FIELD HANDLING
# ───────────────────────────────────────────────────────────────
field_handling:
  defaults:
    target_system_empty: "Use search order fallback"
    agents_location_empty: "Search using default search order starting from current directory"
    context_empty: "Infer from REQUEST and AGENTS.md routing analysis"
    request_empty: "Error: REQUEST required - describe the task or goal"
    analysis_scope_empty: "Proceed with AGENTS.md and routed Knowledge Base documents only"

  agents_location_handling:
    from_registry: "Use {ai_systems_base}/{system_folder} path"
    from_path_override: "Use explicit path provided by user"
    fallback: "Use default search order"
    not_found: "Log warning, fallback to default search order, report to user"

  context_inference:
    from_request:
    - extract_task_type
    - identify_domain_or_topic
    - detect_urgency_signals
    - determine_output_expectations
    from_workspace:
    - scan_for_agents_md
    - detect_project_structure
    - identify_existing_standards
    - map_export_folder_availability
    from_routing:
    - knowledge_base_documents_accessed
    - guardrails_applied
    - workflow_requirements_identified

  analysis_scope_handling:
    reference_materials:
      present: "Load and scan files/folders for patterns, standards, and context"
      empty: "Proceed with AGENTS.md routing only"
      not_accessible: "Log warning and proceed without external references"
    extract_principles:
      present: "Extract and apply specified frameworks or patterns"
      empty: "Use AGENTS.md and Knowledge Base principles only"

# ───────────────────────────────────────────────────────────────
# WORKFLOW
# ───────────────────────────────────────────────────────────────
workflow:
  step_1_locate_agents_md:
    purpose: Search for and resolve AGENTS.md file using provided path or search order
    priority:
    - if_agents_location_from_registry: "Use {ai_systems_base}/{system_folder}/AGENTS.md"
    - if_agents_location_from_path_override: "Use provided path/AGENTS.md"
    - fallback: "Use default search order: ./AGENTS.md → ../AGENTS.md → ../../AGENTS.md"
    activities:
    - Check if [AGENTS_LOCATION] was resolved from registry or path override
    - If resolved, attempt to locate AGENTS.md at that path
    - If not resolved, search using default order
    - Check for redirect signals (e.g., CLAUDE.md pointing to AGENTS.md)
    - Set agent_scope_root to folder containing resolved AGENTS.md
    - Lock identity to this AGENTS.md for duration of conversation
    validation: agents_md_found
    failure_mode: "Output: 'AGENTS.md not found at specified location or search paths—please provide correct path.' STOP."
    identity_and_scope_binding:
      agent_scope_root: "Set to folder containing resolved AGENTS.md"
      identity_lock: "Treat this AGENTS.md and its folder as sole identity and scope for conversation"
    outputs:
    - agents_md_path
    - agent_scope_root
    - identity_locked
    - target_system_confirmed

  step_2_read_and_route:
    purpose: Read AGENTS.md end-to-end and follow internal routing logic
    understand:
    - AGENTS.md is a router, not just a document
    - It redirects to Knowledge Base documents based on context
    - It may have operation/command-aware routing
    - It defines mandatory reading sequences
    activities:
    - Read AGENTS.md completely from beginning to end
    - Extract behavioral guardrails and anti-patterns
    - Extract workflow requirements and core principles
    - Understand routing instructions
    - Follow AGENTS.md internal routing sequence
    - Read Knowledge Base documents as specified by routing
    validation: agents_md_parsed_and_routing_understood
    outputs:
    - behavioral_guardrails
    - anti_patterns
    - workflow_requirements
    - core_principles
    - routing_instructions
    - knowledge_base_documents_read

  step_3_acknowledge_compliance:
    purpose: Confirm compliance in first response to user
    format: |
      AGENTS.md read and applied: {agents_md_path}
      System: {target_system}
      Summary: {1-3 line summary}
      Knowledge Base routing: {documents read}
    note: "Include resolved system and path information"
    activities:
    - Format compliance acknowledgment message
    - Include full path to resolved AGENTS.md
    - Include target system name from registry
    - Provide 1-3 line summary of agent's role/purpose
    - List Knowledge Base documents accessed during routing
    validation: compliance_confirmed
    outputs:
    - compliance_acknowledgment_sent

  step_4_parse_context:
    input: "[CONTEXT]"
    purpose: Extract environment, state, constraints from context field
    activities:
    - Check if CONTEXT is provided
    - If provided, parse for environment, state, constraints
    - If empty, infer context:
      - From REQUEST: task type, domain, urgency, output expectations
      - From workspace: project structure, standards, export folder
      - From routing: guardrails, workflow requirements
    - Ask targeted questions if critical info missing (use AskUserQuestion)
    validation: context_understood
    outputs:
    - context_parsed
    - environment_understood
    - constraints_identified

  step_5_process_analysis_scope:
    input: "[ANALYSIS_SCOPE]"
    purpose: Load and analyze reference materials if provided
    understand:
    - Reference materials provide supplementary context
    - Principles to extract guide the analysis approach
    - This enriches but does NOT override AGENTS.md routing
    activities:
    - Check if ANALYSIS_SCOPE is provided
    - If provided:
      - Load reference_materials files/folders
      - Scan for patterns, standards, context
      - Extract specified principles (voice, structure, methodology)
    - If not accessible, log warning and proceed without
    - If empty, skip to next step
    validation: analysis_scope_incorporated_or_skipped
    outputs:
    - reference_materials_loaded
    - principles_extracted

  step_6_execute_request:
    input: "[REQUEST]"
    purpose: Process request strictly per AGENTS.md + Knowledge Base guidelines
    activities:
    - Validate REQUEST is not empty (error if empty)
    - Process request according to AGENTS.md constraints
    - Follow workflow_requirements identified in step 2
    - Apply behavioral_guardrails and avoid anti_patterns
    - Use context from step 4 and analysis_scope from step 5
    - Resolve conflicts in favor of AGENTS.md
    - Check if export folder exists in agent_scope_root
    - If export folder exists:
      - Deliver output files to ./export/ with sequential numbering
      - "Use format: [###] - filename.ext"
    - If export folder missing and output needed:
      - Notify user and request folder creation if relevant
    validation: request_completed
    conflict_resolution: "Follow AGENTS.md and explain adjustment"
    output_handling:
      if_export_folder_exists: "Deliver to ./export/ within agent_scope_root with [###] - filename format"
      if_folder_missing: "Notify user and request folder creation if relevant"
      sequential_numbering: "Check existing files, use next number (001, 002, etc.)"
    outputs:
    - request_processed
    - output_delivered

  step_7_context_persistence:
    purpose: Save execution context to memory files for future sessions
    activities:
    - Invoke workflows-save-context skill (preferred method)
    - Auto-generate HTML anchor tags for grep-able sections
    - "Use anchor format: <!-- anchor: category-topic-spec -->"
    - Save to spec folder memory/ if spec folder context active
    - Otherwise save to .claude/plans/ or agent_scope_root
    - Fallback to legacy inline template if skill unavailable
    validation: context_saved_or_skipped
    outputs:
    - memory_file_created
    - anchors_generated
    - context_persisted

# ───────────────────────────────────────────────────────────────
# TERMINATION
# ───────────────────────────────────────────────────────────────
termination:
  after_step: 7
  message: |
    Agent Router Complete

    System: {target_system}
    AGENTS.md: {agents_md_path}
    Agent Scope: {agent_scope_root}
    Request: {request_summary}

    Routing:
    - Knowledge Base documents: {knowledge_base_documents_read}
    - Output location: {output_location}

    Next Steps:
    - Review output
    - Run subsequent commands as needed

    STATUS=OK
  next_steps:
  - Review output in export folder or workspace
  - Run subsequent commands within this agent's scope

# ───────────────────────────────────────────────────────────────
# ERROR RECOVERY
# ───────────────────────────────────────────────────────────────
error_recovery:
  agents_md_not_found:
    action: "STOP with clear error message"
    message: |
      AGENTS.md not found at specified location or search paths.

      System: {target_system}
      Path tried: {agents_location}

      Search attempted:
      - {agents_location}/AGENTS.md (from registry/path)
      - ./AGENTS.md
      - ../AGENTS.md
      - ../../AGENTS.md

      Available systems: clickup, webflow, notion, media, po, prompt
      Or use: path: /custom/path

  request_empty:
    action: "STOP and prompt user"
    message: "REQUEST required - please describe the task or goal."

  routing_fails:
    action: "Continue with AGENTS.md only, log warning"
    message: "Warning: Some Knowledge Base documents not found. Proceeding with available routing."

  knowledge_base_missing:
    action: "Continue with AGENTS.md core guidelines"
    message: "Warning: Knowledge Base documents not accessible. Using AGENTS.md core guidelines only."

  export_folder_missing:
    action: "Notify user if output needs delivery"
    message: "Export folder not found. Output will be delivered to workspace or specify export location."

# ───────────────────────────────────────────────────────────────
# RULES
# ───────────────────────────────────────────────────────────────
rules:
  ALWAYS:
  - use_resolved_agents_location_from_registry_or_path_first
  - read_agents_md_completely_before_processing_request
  - acknowledge_compliance_with_system_name_in_first_response
  - follow_agents_md_constraints_and_workflows
  - treat_folder_containing_resolved_agents_md_as_active_agent_scope_root
  - lock_identity_to_resolved_agents_md_for_duration_of_conversation
  - restrict_file_operations_to_agent_scope_root_and_subfolders_unless_explicitly_allowed_by_agents_md
  - resolve_conflicts_in_favor_of_agents_md
  - check_export_folder_exists_before_creating_output
  - deliver_all_output_files_to_export_folder_with_sequential_numbering

  NEVER:
  - skip_or_defer_agents_md_reading
  - guess_agents_md_content
  - proceed_without_agents_md_confirmation
  - override_agents_md_instructions
  - switch_to_different_agents_md_mid_conversation_without_explicit_user_retargeting
  - act_as_multiple_agents_simultaneously
  - access_or_modify_other_ai_system_folders_outside_agent_scope_unless_explicitly_routed_or_authorized
  - create_output_files_outside_export_folder_when_available
